FROM apache/airflow:2.8.0-python3.11

# Switch to root user for installing system packages
USER root

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        libpq-dev \
        postgresql-client \
        curl \
        netcat-traditional \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Switch back to airflow user
USER airflow

# Copy requirements file
COPY requirements.txt /requirements.txt

# Install Python dependencies
RUN pip install --no-cache-dir --user -r /requirements.txt

# Set PYTHONPATH to include dags directory
ENV PYTHONPATH="${PYTHONPATH}:/opt/airflow/dags"

# Create necessary directories
USER root
RUN mkdir -p /opt/airflow/logs /opt/airflow/dags /opt/airflow/plugins \
    && chown -R airflow:root /opt/airflow/logs /opt/airflow/dags /opt/airflow/plugins

USER airflow

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=5 \
    CMD airflow jobs check --job-type SchedulerJob --hostname "$(hostname)" || exit 1
